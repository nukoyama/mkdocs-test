---
title: kaishiの解説
---

# はじめに

ここでは、kaishiの構造や、独自コマンドなどの解説をします。

ここの話は知っておかなくても、テンプレをコピペして編集すれば、会誌記事を書く分には問題ないかと思います。

会誌のリポジトリ管理の引継ぎが主な目的です。

# kaishi の歴史

ここは読み飛ばしていいです。

思想やら目的がわかりやすいかと思うので、一応開発の歴史を簡単に述べます。

## 2016年度

2016年度までの会誌は、WordでもLaTaXでもなんでもいいので、とりあえず各自記事を作成し、PDF化あるいは印刷して順番に並べてから手動でページ番号や目次を作っていました。

できるだけ自動化したいのと、やはりLaTeXで作った方が美しくできるので、来年からはみんなLaTeXで作りましょうということになりました。

## 2017年度

夏に開催したOB会で去年の会誌を配布することになったのですが、良い機会なのでLaTeXで作り直すことにしました。

当時はまだGitHubは利用していませんでしたが、ソースコードはあとからリポジトリを作って置いています。

- [vuccaken/kaishi2017ob - GitHub](https://github.com/vuccaken/kaishi2017ob){target=_blank}

工夫した点は、記事毎にファイルを分割して、`\input` コマンンドで各記事を呼び出してマージしているぐらいです。

学園祭で配布した2017年度の会誌では、少しだけソースをきれいにしました。

- [vuccaken/kaishi2017 - GitHub](https://github.com/vuccaken/kaishi2017){target=_blank}

この時点では、各記事が完全に完成してから、最後にまとめる作業をするという感じでした。

## 2018年度

この年からは、記事のタイトル出力などのコマンド群をマクロ化し、表紙もLaTeXで作るようにしました（画像を読み込むだけですが）。

また、jsbookクラスの `\chapter` コマンドを改造して、目次に記事タイトルと著者を出力できるようにしました。

さらに、記事の更新とマージの作業を同時に行えるように努力した結果、リポジトリを見てもらえばわかるようにファイルがかなり散らかっています。

- [vuccaken/kaishi2018 - GitHub](https://github.com/vuccaken/kaishi2018){target=_blank}

`input` コマンドの代わりにemathパッケージの `\ReadTeXFile` コマンドを使うことで、記事単体でもタイプセットでき、そのままマージもできるようになりました（読み込むファイルに `\documentclass` などが書いてあっても良い）。

とはいえ、記事の更新はSlackにアップロードされたファイルを、編集者がダウンロードして随時マージという作業をしていました。

どれが最新のファイルかわからなくなったり、同時作業で衝突し、進捗が消滅したりしていました。

## 2019年度

2019年度からはLaTeXをある程度理解し、latexmkを明示的に使えるようになり、vscodeというエディタも使って効率的にタイプセットできるようになりました。

がっつりマクロを組み、ディレクトリ構造はスマートになり、マージする環境と記事を更新する環境を同じにしました。

`input` コマンドの代わりは emath のものはもう使わず、自分で改造したものを使っています。

- [vuccaken/kaishi2019 - GitHub](https://github.com/vuccaken/kaishi2019){target=_blank}

また、この年からGitHubを使って共同開発するようにしました。

と言っても誰もGitが使えなかったので、ただのクラウドストレージとしての機能しか果たしていませんでしたが。

あとは、MacとWindowsでデフォルトのフォントが異なり、完成版のPDFに違いがでてしまうので、フリーの源ノというフォントを使うようにしました。

独自マクロなど非自明なことが増えたので、環境構築のマニュアルを簡単に作りました。

## 2020年度

殆どは去年のものがベースになっていますが、細かいところを少し変更しました。

- [vuccaken/kaishi2020 - GitHub](https://github.com/vuccaken/kaishi2020){target=_blank}

まず、今までは sty ファイルに色々マクロを書くことで jsbook クラスを改造していましたが、今回からはちゃんと cls ファイルを作ってそこに書くようにしました。

また、去年は各記事のプリアンブルは同一のファイルに書くようにしていましたが、同じファイルをみんなで弄るのはアレなので、記事毎に分割しました。

未だ全然使いこなせていませんが、一応もう少しGitのありがたみを感じるべく、branch運用を始めました。

開発環境はvscodeで統一することにしました。そのための設定ファイルや `ltexmkrc` なども用意しました。

という感じで年々開発が進んできましたが、そろそろ引き継がないとまずいので、ちゃんとマニュアルを作ることにしました。


# kaishiのディレクトリ構造

kaishiのディレクトリ構造は以下のようになっています；

```
kaishi/
  |- etc/            % 設定メモなど、いろいろ
  |- fonts/          % フォント（源ノ）を入れる
  |- sty/            % texliveで標準インストールされないものや自作スタイルファイル
  |    |- v-hyperref.sty     % hyperref.sty の改造版
  |    |- vkaishi.cls        % 会誌のクラスファイル
  |    `- vuccaken.sty       % 共通設定や細かいマクロ
  |- tex/
  |   |- _BK/         % 表紙や奥付など
  |   |- _sample/     % 会誌記事サンプル
  |   |- _template/   % コピペ用テンプレート
  |   ...
  |
  |- .gitignore      % git で無視するファイルを指定
  |- .latexmkrc      % latexmk の設定ファイル
  `- merge.tex       % 各texファイルをまとめる
```

`/tex/` 以下に、記事毎にディレクトリを作り、その中で記事の更新作業を行います。

`/merge.tex` をタイプセットすることで、それらの記事を読み込み、マージして会誌を完成させます。

必要なstyファイルなどは `/sty/` 以下に置いています。
ここにあるstyなどを、`/merge.tex` や各記事のtexファイルでロードするようにしています。

タイプセットに必要なLaTeXの環境設定は `.latexmkrc` に書かれています。
エディタvscodeのための設定ファイルのサンプルは `/etc/` の中に置いています。

# 記事のtexファイル

まずは記事のtexファイルで使われているコマンドの解説をします。

最小限のソースコードは以下のような感じです；

```tex linenums="1"
\documentclass[uplatex,dvipdfmx]{vkaishi}

% \usepackage{v-hyperref}
\usepackage{vuccaken}
\usepackage{template} % Your sty File

% \analogtrue
% \colorfalse

\begin{document}

\vctitle{会誌原稿テンプレート} % タイトル
\vcauthor{\vname{テンプレ}{太郎}} % 名前
\vcbelong{テンプレ科学科} % 所属
\vcgrade{4 }% 回生

\mokuji{2} % 目次出力
\vcmaketitle % タイトル出力

%% 以下本文
\section*{はじめに}
...

%% 参考文献
\begin{thebibliography}{99}
  \bibitem{label-1} 著者1・著者2，『本のタイトル』，出版社，出版年．
  \bibitem{label-2} ...
\end{thebibliography}

\end{document}
```

上から順に説明していきます。

## document class

```tex
\documentclass[uplatex,dvipdfmx]{vkaishi}
```

おなじみの `\documentclass` コマンドです。

ここではひとつめの引数に `uplatex` と `dvipdfmx` を与えています。
これは、kaishiは `uplatex` でタイプセットし、`dvipdfmx` を使ってpdfを生成するということです。

ふたつめの引数 `vkaishi` は自作のクラスファイルの名前です。
ソースは `/sty/` に置いてあります。

`vkaishi` クラスは、`jsbook` クラスという和文書籍のためのクラスを改造したものです。
実際、`vkaishi.cls` の中で `jsbook` クラスを読み込んでいます。

## styファイルの読み込み

プリアンブルではまず、styファイルを読み込んでいます；

```tex
% \usepackage{v-hyperref}
\usepackage{vuccaken}
\usepackage{template} % Your sty File
```

`v-hyperref` パッケージと `vuccaken` パッケージは自作のstyファイルで、こちらも `/sty/` の中にソースがあります。

`v-hyperref` パッケージは、目次や式番号などにハイパーリンクを付けるためのパッケージ `hyperref.sty` を、自作のクラスファイル `vkaishi.cls` でもうまく機能するために改造（調整）したものです。

このパッケージを読み込むと、ハイパーリンクが埋め込まれますが、タイプセット回数が増えたりして少し重くなるので、記事作成中はコメントアウトしておくことをお勧めします。

`vuccaken` パッケージは、共通で必要なパッケージなどをまとめて読み込んだり、簡単なマクロを書いたりしています。
このパッケージは読み込んでいないとタイプセットに失敗するので、ちゃんと書いておいてください。

3つめに読み込んでいるのは、本来プリアンブルに書くべき、記事で必要なパッケージやマクロを別ファイル（styファイル）にしたものです。
これは、マージの過程でどうしても必要になってしまったので、面倒ですが、本来プリアンブルに書きたいことは別ファイルにして読み込んでください。

!!! info
    各記事のtexファイルのプリアンブルに書かれていることは、マージする際には読み飛ばされます。

    プリアンブル部分は別ファイルにし、`merge.tex` ではそれを記事のtexファイルとは別に読み込みます。

## if文スイッチ

プリアンブルにはまだ何か書かれています；

```tex
% \analogtrue
% \colorfalse
```

デフォルトではコメントアウトしていますが、これらはif文のスイッチです。
コメントアウトを消すと機能します。

`\analogtrue` は、会誌を紙に印刷する際に、見開きのページの間にマージン（スペース）を入れるためのスイッチです。
これをオンにすることで、インナーマージンが入った際の見栄えを確認することができます。

コンテンツ（本文）の幅は変わらず、外側に平行移動して内側にマージンを入れるだけで、レイアウトが崩れたりとかはしないので、わざわざ気にしないで良いです。

`\colorfalse` は、カラー印刷用とモノクロ印刷用で図などを切り替えるためのスイッチです。
これをオンにすると、モノクロ印刷用にカラーをオフにします。

このスイッチでカラー用とモノクロ用で図などを切り替えるには、`\vcolor` コマンドを使って以下のようにします；

```tex
\vcolor{
  %% if color true
  \includegraphics{color.png}
}{
  %% if color false
  \includegraphics{black-white.png}
}
```

まあ使いたい人だけ使ってください。

## タイトル出力など

`\begin{document}` から `\end{document}` までが本文を書く部分になります。

まずはじめに以下のようなコマンドたちが書かれています；

```tex
\vctitle{会誌原稿テンプレート} % タイトル
\vcauthor{\vname{テンプレ}{太郎}} % 名前
\vcbelong{テンプレ科学科} % 所属
\vcgrade{4} % 回生

\mokuji{2} % 目次出力
\vcmaketitle % タイトル出力
```

`\vctitle` は記事のタイトル、`\vcauthor` は著者名、`\vcbelong` は著者の所属する学部学科、`\vcgrade` は著者の回生を指定するコマンドです。

ここで指定した値を、その下の `\vcmaketitle` というコマンドで出力します。

!!! note
    n回生の数字はアラビア数字で統一しておきましょう。

引数を2つとる `\vname{}{}` というコマンドには、名前を family name と first name に分けて入力します。
例えば、`\vname{中須}{かすみ}` のような感じです。

!!! info
    名前の書き方には、family name と first name の間に半角や全角のスペースを入れたり入れなかったりといろいろ流儀があります。

    別になんでも良いのですが、少なくとも会誌全体では統一したいので、一応こういうマクロを作りました。

`\mokuji{2}` というコマンドでは、目次を出力しています。
引数の数字は、目次に表示するセクションの深さです。

目次確認用に良かれと思って作ったコマンドなので、要らなかったらコメントアウトしておいてください。

!!! info
    `\mokuji` コマンドは、普通に目次を出力するコマンド `\tableofcontents` をif文で挟んだだけの自作コマンドです。

    `merge.tex` で記事を読み込む際には、そこに目次を出力しないようにしたかっただけです。

## 見出し（セクション）

記事のタイトルは結局のところ `\chapter` コマンドで出力しているので、会誌記事内で使える最大の見出しコマンドは `\section` です。

記事内で `\chapter` は使わず、`\section` 以下でうまくやりくりしてください。

## 参考文献

参考文献は `thebibliography` 環境で出力します。

```tex
\begin{thebibliography}{99}
  \bibitem{label-1} 著者1・著者2，『本のタイトル』，出版社，出版年．
  \bibitem{label-2} ...
\end{thebibliography}
```

`item` 環境と同じような感じで使ってください。

ただし、`\bibitem` には必ず引数が必要です。
ここで指定したラベルを本文中で `\cite{label}` として呼び出すことで、文献番号を参照できます。

ラベルの指定の仕方は、`著者名+出版年` がお勧めです。
例えば `\bibitem{nakasu2020}` のような感じです。

!!! attention
    この `\bibitem` のラベルは、会誌全体を通して一意的でなくてはなりません。

    全体をマージした際に、エラーとはなりませんが警告が出ます。
    ラベル名が他人と被ってしまった際は、面倒ではありますが、どちらかの人にラベル名を変更してもらうようお願いします。

    プログラミングの力及ばず、この問題は解決することができませんでした。


# マージ用texファイル

ここでは、各々が書いた会誌記事を読み込んでマージ（統合）するためのtexファイル `merge.tex` のソースコードについて解説します。

ほげほげ